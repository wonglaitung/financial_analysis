# AI财务分析工具 - 现金流量预测与债务服务比率分析项目

## 项目概述

本项目是一个基于AI模型的财务分析工具，专门用于从企业年报中提取财务数据并进行现金流测算分析。项目结合了传统的现金流量预测模板与先进的AI技术，能够自动化地从PDF年报中提取财务信息并进行深度分析。项目主要围绕以下核心内容：

1. **AI驱动的财务数据提取**：使用Qwen3-VL-Plus模型从PDF年报中提取资产负债表、利润表、现金流量表等财务信息
2. **现金流测算分析**：基于提取的财务数据，按照现金流测算方案进行分析
3. **多公司支持**：可分析不同公司的财务报告
4. **关键指标计算**：计算经营活动现金流(CFO)、自由现金流(FCF)、债务偿还覆盖率(DSCR)等关键指标
5. **传统现金流量预测模板**：基于香港金融管理局（HKMA）监管要求的现金流量预测模板，用于评估债务服务比率（DSR）和承租人偿债能力

## 项目背景

根据香港金融管理局（HKMA）监管要求（SPM CR-G-2），现金流量预测和债务服务能力评估是信贷决策的关键标准。对于所有期限超过1年的融资，包括银团贷款、双边定期贷款、"内保外贷"下的定期贷款、证券化限额、建设/项目贷款和期限超过1年的抵押贷款，都必须进行现金流量预测和DSR计算。

本项目通过AI技术增强了传统财务分析方法，能够自动化处理复杂的企业年报文档，提取关键财务信息并进行深度分析，大大提高了财务分析的效率和准确性。

## 技术架构

### 核心技术栈
- **Python**: 主要编程语言
- **OpenAI API**: 与AI模型交互的API接口
- **PyMuPDF (fitz)**: PDF文档处理
- **PIL**: 图像处理库
- **Qwen3-VL-Plus**: 用于财务数据提取的视觉语言模型
- **Qwen3-Max**: 用于现金流分析的大语言模型

### 环境配置
1. 设置API密钥和基础URL：
   ```bash
   source set_key.sh
   ```

2. 确保环境变量`API_KEY`和`BASE_URL`已正确配置

## 核心文件说明

### 1. 主程序文件
- **文件名**：`extract_balance_sheet.py`
- **功能**：包含完整的财务数据提取和现金流分析流程
- **主要组件**：
  - `extract_financial_data()`: 从PDF中提取全面的财务数据（资产负债表、利润表、现金流量表及附注）
  - `perform_cash_flow_analysis()`: 对提取的数据进行现金流分析
  - `generate_cash_flow_report_template()`: 生成符合模板格式的分析报告
  - `cash_flow_analysis()`: 完整的分析流程：提取数据 → 现金流分析 → 生成报告

### 2. 现金流量报告模板
- **文件名**：`cash_flow_report_template.md`
- **内容**：标准化的现金流分析报告模板，包含：
  - 报告基本信息
  - 核心假设与测算方法
  - 历史现金流分析（间接法）
  - 关键现金流指标分析
  - 营运资金与资本支出校准
  - 未来现金流滚动预测（直接法）
  - 风险情景与压力测试
  - 结论与行动建议

### 3. 配置文件
- **文件名**：`set_key.sh`
- **功能**：API密钥和基础URL的配置文件
- **内容**：包含BASE_URL和API_KEY环境变量

### 4. 现金流量预测模板（Excel文件）
- **文件名**：DSR & Cashflow Forecast 2025_Updated.xlsx
- **功能**：包含DSR计算、现金流量预测、压力测试等功能
- **主要工作表**：
  - OIC input for DSR cal：DSR计算的基本信息输入
  - Working & DSR calculation：DSR计算工作表
  - OIC Input for Cash Flow Forecast：现金流量预测输入

### 5. 现金流量预测模板指南
- **文件名**：Cash Flow Forecast Template Guide.docx
- **内容**：详细说明现金流量预测模板的使用方法，包括：
  - 基本信息输入要求
  - 财务信息来源
  - 债务融资分类（现有债务与新债务）
  - 现金流量预测方法（基础案例与压力案例）
  - 假设和合理性验证要求

### 6. 实际分析报告示例
- **文件名**：交银金租_2024_现金流分析报告.md
- **内容**：使用AI模型生成的实际现金流分析报告
- **关键信息**：
  - 详细的现金流分析结果
  - 关键财务指标计算
  - 风险评估与压力测试

### 7. 其他文档
- **现金流测算方案.docx**: 详细的现金流测算方法论和实施方案
- **交银金租2024年报.pdf**: 示例财务报告
- **中旅国际2024年报（数据加附注）.pdf**: 示例财务报告

## 核心功能与流程

### 1. 财务数据提取
使用Qwen3-VL-Plus模型从PDF年报中提取：
- 合并资产负债表（资产、负债和股东权益各项目及金额）
- 合并利润表（营业收入、营业成本、净利润等）
- 合并现金流量表（经营活动、投资活动、筹资活动现金流）
- 财务报表附注关键信息（应收账款账龄结构、存货构成、固定资产折旧政策、借款明细、资本承诺、或有负债等）

### 2. 现金流分析
使用Qwen3-Max模型进行深度现金流分析：
- 历史现金流分析（间接法）：从净利润开始，调整非现金项目及营运资本变动
- 关键现金流指标计算（CFO、FCF、DSCR、利息保障倍数、现金比率）
- 附注信息校准：分析应收账款账龄、固定资产折旧政策、借款到期结构等
- 未来现金流预测（直接法）：预测现金流入与流出
- 风险控制与压力测试：收入下降情景测试、敏感性分析

### 3. 报告生成
根据提取的财务数据生成标准化的现金流分析报告，包含：
- 详细的数据分析
- 关键指标计算
- 风险评估
- 管理建议

## 关键指标和方法

### DSR（债务服务比率）计算
- **定义**：总义务/EBITDA
- **标准**：原则上DSR应小于1
- **压力测试**：基准EBITDA的10%折扣（即90%的基准EBITDA）和基准利率增加2%

### 现金流量预测
- **预测期**：覆盖整个贷款生命周期，显示全额债务偿还
- **输入项目**：
  - 销售额及增长率
  - 毛利率
  - 运营费用及增长率
  - 投资/租金收入
  - 投资联营公司或合资企业的贡献
  - 税率
  - 股息支付率
  - 坏账准备
  - 应收账款周转天数
  - 存货周转天数
  - 应付款周转天数
  - 资本支出

### AI分析关键指标
- **经营活动现金流(CFO)**: 从净利润调整非现金项目得出
- **自由现金流(FCF)**: CFO - 资本性支出
- **债务偿还覆盖率(DSCR)**: (CFO - 必要CAPEX) ÷ (当期应还本金 + 利息)
- **利息保障倍数**: EBIT ÷ 利息支出
- **现金比率**: (货币资金 + 短期理财) ÷ 短期债务

## 业务流程

1. **环境配置**：设置API密钥和基础URL
2. **数据提取**：使用qwen3-vl-plus从PDF年报中提取财务数据
3. **现金流分析**：使用qwen3-max对提取的数据进行深度分析
4. **报告生成**：生成符合模板格式的现金流分析报告
5. **结果输出**：保存分析报告到文件
6. **结果分析**：评估借款人的偿债能力

## 重要假设

- **基准案例**：基于历史趋势、市场环境、行业情况等的合理假设
- **压力测试**：销售额和毛利率在基准基础上减少10%，利率增加2%
- **资本支出**：基于借款人的扩张计划、维护性资本支出等
- **债务偿还**：按照贷款协议的还款计划进行
- **AI模型准确性**：假设AI模型能准确提取财务数据并进行合理分析

## 合规要求

- 符合香港金融管理局监管要求
- 适用于公司贷款和制造业贷款（Corp Type=1）和中小企业及贸易贷款（Corp Type=0）
- 预测覆盖整个融资期间，包含全额债务偿还
- AI分析结果需与传统方法相互验证

## 使用说明

### 基本用法
1. 设置API配置：
   ```bash
   source set_key.sh
   ```

2. 运行主程序分析默认年报：
   ```bash
   python extract_balance_sheet.py
   ```

### 自定义分析
分析其他公司的年报：
```python
from extract_balance_sheet import cash_flow_analysis

cash_flow_analysis(
    pdf_path="/path/to/your/company_report.pdf",
    company_name="公司名称",
    year="年份"
)
```

### 分析流程
1. 根据借款人的具体情况填写Excel模板中的黄色高亮单元格（传统方法）
2. 使用AI工具自动从PDF年报中提取财务数据
3. 所有假设必须有明确的依据和文档支持
4. 评估借款人的历史DSR趋势
5. 进行基准和压力测试两种情况的分析
6. 确保所有输入数据与最新财务报表一致
7. 验证AI分析结果与传统方法的一致性