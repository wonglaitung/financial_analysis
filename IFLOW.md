# Financial Analysis Project

## 项目概述

这是一个基于AI模型的财务分析工具，专门用于从企业年报中提取财务数据并进行现金流测算分析。项目使用Qwen3-VL-Plus模型处理PDF格式的年报，提取资产负债表、利润表、现金流量表等财务数据，并结合现金流测算方案对企业的现金流状况进行评估。

项目基于Python开发，采用阿里云通义千问系列模型（Qwen3-VL-Plus 和 Qwen3-Max）进行财务数据提取和分析。通过环境变量管理API配置，支持多公司财务报告分析，具备完整的现金流测算功能。

## 主要功能

- **财务数据提取**：从PDF年报中提取资产负债表、利润表、现金流量表等财务信息
- **现金流测算分析**：基于提取的财务数据，按照现金流测算方案进行分析
- **多公司支持**：可分析不同公司的财务报告，只需传入相应的PDF路径、公司名称和年份
- **指标计算**：计算关键现金流指标，如经营活动现金流(CFO)、自由现金流(FCF)、债务偿还覆盖率(DSCR)等
- **智能分析**：利用AI大模型进行财务数据理解和深度分析
- **报告生成**：生成符合专业模板格式的现金流分析报告
- **报告保存**：将生成的分析报告保存为Markdown文件

## 核心文件

### extract_balance_sheet.py
主程序文件，包含以下功能模块：
- `extract_financial_data()`：使用Qwen3-VL-Plus模型提取财务数据
- `perform_cash_flow_analysis()`：使用Qwen3-Max模型进行现金流分析
- `generate_cash_flow_report_template()`：生成符合模板格式的现金流分析报告
- `save_report_to_file()`：保存报告到文件
- `cash_flow_analysis()`：完整的现金流分析流程，整合数据提取、分析和报告生成

### 环境配置文件

#### set_key.sh
包含API密钥和基础URL的配置，使用环境变量方式管理。

### 报告模板文件

#### cash_flow_report_template.md
现金流测算分析报告模板，定义了标准报告格式和结构。

### 输入文件

#### 财务报告
- `交银金租2024年报（数据加附注）.pdf`：交银金融租赁有限责任公司2024年年报
- `中旅国际2024年报（数据加附注）.pdf`：中旅国际2024年报（数据加附注）

#### 方案文档
- `现金流测算方案.docx`：详细的现金流测算方法论和实施方案

## 技术栈

- **Python**：主要开发语言
- **阿里云通义千问API**：AI模型接口（兼容OpenAI格式）
- **PyMuPDF (fitz)**：PDF处理和转换
- **PIL (Pillow)**：图像处理
- **Base64**：图像数据编码
- **Qwen3-VL-Plus**：用于财务数据提取的视觉语言模型
- **Qwen3-Max**：用于现金流分析和报告生成的大语言模型
- **OpenAI Python SDK**：API客户端库

## API配置

项目使用环境变量管理API配置：
- `API_KEY`：阿里云通义千问API密钥
- `BASE_URL`：API基础URL，当前配置为阿里云DashScope兼容模式

配置在`set_key.sh`文件中定义，并在Python代码中通过`os.getenv()`获取。

### 当前API配置
- BASE_URL: `https://dashscope.aliyuncs.com/compatible-mode/v1`
- 使用阿里云DashScope服务的兼容OpenAI格式的API端点

## 现金流测算方案

项目遵循详细的现金流测算方案，包含：

1. **测算目标**：评估企业在未来特定期间内产生和支配现金的能力
2. **数据来源**：三大报表主表（利润表、资产负债表、现金流量表）和财务报表附注
3. **测算方法**：
   - 历史现金流分析（间接法）
   - 未来现金流预测（直接法）
4. **关键指标**：经营活动现金流、自由现金流、债务偿还覆盖率等
5. **风险控制**：附注校准、压力测试、交叉验证等

## 现金流分析报告模板

项目提供标准化的现金流分析报告模板，包含：

1. **报告基本信息**：报告主体、期间、编制日期等
2. **核心假设与测算方法**：分析方法和关键假设
3. **历史现金流分析**：采用间接法分析历史现金流
4. **关键指标分析**：现金流相关指标计算与评价
5. **营运资金与资本支出校准**：深入分析营运资金和资本支出
6. **未来现金流预测**：预测未来12个月现金流
7. **风险情景与压力测试**：多情景风险分析
8. **结论与行动建议**：分析结论和管理建议

## 使用方法

### 环境准备
1. **设置环境变量**：运行`source set_key.sh`设置API密钥和基础URL
2. **安装依赖**：确保已安装所需Python包（openai, fitz/pymupdf, pillow等）

### 运行分析
1. **设置环境变量**：
   ```bash
   source set_key.sh
   ```

2. **运行分析**：
   - 执行`python extract_balance_sheet.py`进行默认公司（交银金租）的现金流分析
   - 或者在代码中修改PDF路径和公司信息以分析其他公司

3. **自定义分析**：
   - 调用`cash_flow_analysis(pdf_path, company_name, year)`函数分析其他公司的年报
   - 传入PDF路径、公司名称和年份参数

### 程序执行流程
1. **PDF处理**：将PDF文档的每一页转换为高分辨率图像
2. **数据提取**：使用Qwen3-VL-Plus模型识别和提取财务数据
3. **现金流分析**：使用Qwen3-Max模型进行深度现金流分析
4. **报告生成**：使用Qwen3-Max模型生成符合模板格式的现金流分析报告
5. **结果输出**：生成详细的现金流测算报告并保存到文件

## 关键算法与分析方法

### 历史现金流分析（间接法）
```
经营活动现金流（CFO）= 净利润
+ 折旧、摊销、资产减值等非现金费用
– 非经营性收益（如投资收益）
– 营运资本增加（应收↑、存货↑）
+ 营运资本减少（应付↑）
```

### 关键指标计算
- **自由现金流（FCF）**：CFO – 资本性支出
- **债务偿还覆盖率（DSCR）**：（CFO – 必要CAPEX）÷（当期应还本金 + 利息）
- **利息保障倍数**：EBIT ÷ 利息支出
- **现金比率**：（货币资金 + 短期理财）÷ 短期债务

### 分析维度
1. **历史现金流分析**
   - 从净利润开始，调整非现金项目（如折旧摊销）
   - 调整营运资本变动（应收账款、存货、应付账款等）
   - 计算经营活动现金流(CFO)

2. **关键现金流指标计算**
   - 经营活动现金流(CFO)
   - 自由现金流(FCF) = CFO - 资本性支出
   - 债务偿还覆盖率(DSCR) = (CFO - 必要CAPEX) ÷ (当期应还本金 + 利息)
   - 利息保障倍数 = EBIT ÷ 利息支出
   - 现金比率 = (货币资金 + 短期理财) ÷ 短期债务

3. **附注信息校准**
   - 分析应收账款账龄结构与回收风险
   - 评估固定资产折旧政策与资本承诺
   - 检查借款到期结构与还款计划
   - 识别或有负债与租赁义务

4. **未来现金流预测（直接法）**
   - 预测现金流入（主营业务收入、其他经营收入）
   - 预测现金流出（资产购置、运营成本、债务本息）
   - 输出月度/季度滚动现金流预测表

5. **风险控制与压力测试**
   - 收入下降10%-20%情景下的DSCR测试
   - 关键变量的敏感性分析
   - 交叉验证净利润与经营活动现金流的关系

## 项目特点

1. **AI驱动**：利用先进的视觉语言模型和大语言模型进行财务分析
2. **全页面扫描**：从PDF的所有页面提取数据，确保不遗漏重要信息
3. **参数化设计**：支持分析不同公司的财务报告
4. **标准报告**：生成符合专业模板的现金流分析报告
5. **安全配置**：API密钥通过环境变量管理，不硬编码在代码中
6. **智能思考**：模型具备完整的思考过程，提供详细的分析逻辑
7. **风险控制**：包含附注校准、压力测试、交叉验证等风险控制机制

## 注意事项

1. **API配置**：确保正确设置`API_KEY`和`BASE_URL`环境变量
2. **PDF格式**：程序支持扫描版和文本版PDF，但文本版效果更佳
3. **模型选择**：使用Qwen3-VL-Plus处理视觉内容，Qwen3-Max处理分析任务
4. **费用控制**：AI模型调用会产生费用，请注意使用量控制
5. **数据安全**：敏感财务数据通过API传输，请确保网络连接安全
6. **报告模板**：利用标准化模板生成专业格式的分析报告